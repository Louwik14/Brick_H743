Pipeline audio Brick H743
========================

Sources et destinations
----------------------
- 2× ADAU1979 (4 canaux chacun) chaînés en TDM 8 canaux → SAI1 bloc B **maître RX** (génère MCLK/BCLK/LRCLK).
- 4 canaux retour vers DAC PCM4104 (sortie ligne + casque) via SAI1 bloc A **esclave TX** (slots 4×32 bits synchronisés sur le bloc B).
- Cartouches SPI-LINK : buffers dédiés (séparés du DAC) exposés par drv_audio.c pour mixer ou router.

Format interne
--------------
- Échantillons int32_t, 24 bits significatifs (poids fort).
- Taille de bloc fixe : AUDIO_FRAMES_PER_BUFFER = 16 frames par canal.
- Buffers statiques ping/pong :
  - audio_in_buffers[2][16][8]
  - audio_out_buffers[2][16][4]
- Buffers SPI-LINK distincts (pas d'écriture directe dans le DAC) :
  - spi_in_buffers[4][16][4]
  - spi_out_buffers[4][16][4]
- Ping/pong contrôlé par interruptions DMA half/full et sémaphore binaire côté thread temps réel.

Ordre des canaux
----------------
- Entrée (ADAU1979) : slots TDM 0..7 mappés sur codec#0 CH0/1/2/3 -> slots 0/2/4/6, codec#1 CH0/1/2/3 -> slots 1/3/5/7.
- Sortie (PCM4104) : 4 slots TX. Convention proposée :
  - Slot 0 : Ligne L
  - Slot 1 : Ligne R
  - Slot 2 : Casque L
  - Slot 3 : Casque R

Configuration SAI/DMA finale
---------------------------
- Bloc B (RX maître) : MODE=Master Receiver, DS=24 bits (slots 32 bits), FRL=255 (256 bits/frame), FSALL=127 (FS actif 128 bits, 50 %), NBSLOT=7 (8 slots), SLOTEN=0x00FF, FBOFF=0, SLOTSZ=32 bits. Génère les horloges pour le bloc A.
- Bloc A (TX esclave) : MODE=Slave Transmitter synchronisé, DS=24 bits (slots 32 bits), FRL=127 (128 bits/frame), FSALL=63 (64 bits actif), NBSLOT=3 (4 slots), SLOTEN=0x000F, FBOFF=0, SLOTSZ=32 bits.
- DMA circulaire double-buffer (half/full IRQ) :
  - RX : AUDIO_SAI_RX_DMA_STREAM (DMAMUX req 87 SAI1_B), priorité 2, P2M, 32 bits, CIRC + HT/TC interrupt, transaction = 2×16×8 samples.
  - TX : AUDIO_SAI_TX_DMA_STREAM (DMAMUX req 86 SAI1_A), priorité 2, M2P, 32 bits, CIRC + HT/TC interrupt, transaction = 2×16×4 samples.
- IRQ DMA : callbacks mettent à jour audio_in_ready_index / audio_out_ready_index et signalent le thread via chBSemSignalI().

Horloges audio (V5)
------------------
- Source horloge SAI : PLL3_P = 49.152 MHz (STM32H743)
- MCLK = 12.288 MHz (PLL3_P / 4)
- BCLK = 12.288 MHz
- FS   = 48 kHz
- PLL ADAU1979 configurée explicitement pour MCLK=12.288 MHz
- Synchronisation H7 ↔ ADAU1979 désormais 100 % déterministe

Latence théorique
-----------------
- Taille bloc : 16 échantillons @ 48 kHz → 333 µs par demi-buffer.
- Pipeline double-buffer (RX half/full + TX half/full) → latence minimale ~0.66 ms côté traitement (hors FIFO SAI/DMA et latence codec).

Insertion DSP
-------------
- Thread audio unique (aucun traitement dans les IRQ). Attente sur sémaphore déclenché par DMA half/full.
- Traitement dans drv_audio_process_block(adc_in, spi_in, dac_out, spi_out, frames).
- Récupération SPI : spilink_pull_cb rempli spi_in_buffers ; export SPI : spilink_push_cb lit spi_out_buffers. Aucun accès direct au buffer DAC.

Rôle des fichiers
-----------------
- drivers/audio_conf.h : constantes globales (fréquence, tailles, mapping SAI/DMA, I2C codecs, type spilink_audio_block_t).
- drivers/audio_codec_ada1979.[ch] : configuration I2C des deux ADAU1979 (PLL, slots TDM distincts, mute numérique). API simple adau1979_init/set_default_config/mute.
- drivers/audio_codec_pcm4104.[ch] : gestion du mute matériel du DAC/ampli casque, préparation des lignes SAI TX.
- drivers/drv_audio.[ch] : buffers ping/pong, buffers SPI dédiés, thread temps réel, hook DSP, configuration SAI via registres CMSIS et DMA circulaire DMAMUX.

Points à peaufiner
------------------
- Vérifier/ajuster le mapping précis des slots TDM (registre SAI_SLOTx) selon le routage audio réel des ADAU1979.
- Valider les numéros exacts de stream/DMAMUX pour SAI1_A / SAI1_B en fonction du schéma (AUDIO_SAI_RX_DMA_STREAM / REQUEST).
- Positionner la ligne de mute casque (AUDIO_HP_MUTE_LINE) sur le GPIO exact du TPA6138A2.
- Intégrer le driver dans drivers_init_all() quand le pipeline audio doit être démarré au boot.

Limitations connues / TODO
--------------------------
- Mapping exact des slots TDM ADAU1979 à valider sur le hardware réel (voir registre SAI_SLOTn et datasheet).
- Volume logiciel actuellement en float ; une migration vers du Q31 pourra être envisagée plus tard pour optimiser le DSP.
- Compléter la stratégie d’erreur (hors chSysHalt) pour les détections I2C (DEVID, PLL lock) en vue d’une V1 produit.

La configuration V4 effectue maintenant une vérification de la PLL des ADAU1979 et du DEVID0 sur chacun des deux codecs ; en cas d’échec, le système s’arrête via chSysHalt().

V6 – Ajout de la matrice de mix MAIN/CUE
---------------------------------------
- Bus logiques internes : MAIN_L/MAIN_R pour la sortie ligne, CUE_L/CUE_R pour la sortie casque.
- Matrice de routage par piste (4 pistes stéréo, ADC0/1 puis ADC2/3 puis ADC4/5 puis ADC6/7) : chaque piste peut être envoyée vers MAIN, vers CUE, vers les deux ou mutée.
- Gains par destination (MAIN et CUE) clampés entre 0.0 et 1.0, initialisés à 1.0 avec routage activé uniquement vers MAIN au boot.
- Mixage réalisé dans drv_audio_process_block : accumulation stéréo MAIN et CUE, soft-clip/limiteur pour éviter la saturation int32, application du volume maître, écriture sur les 4 slots DAC (0/1 = MAIN, 2/3 = CUE).
- Casque : reçoit désormais un mix dédié (bus CUE) permettant une pré-écoute indépendante du bus principal.
- Limites actuelles : pas de panoramique individuel, pas d'EQ, pas de mute solo différencié par destination, pas de sends.
- Points d'extension futurs : insertion des effets après la sommation par bus, ajout d'un pan par piste avant sommation, implémentation de sends/returns vers des effets ou des sorties cartouches SPI-LINK.

V8 – Hardening STM32H743 : D-Cache, DMA et robustesse live
----------------------------------------------------------
- Le D-Cache du H743 rend le DMA dangereux si les buffers résident en RAM cacheable : les écritures DMA RX peuvent être invisibles pour le CPU et les lectures DMA TX peuvent lire des données obsolètes.
- Tous les buffers DMA audio (RX/TX SAI et SPI-LINK) sont désormais placés en RAM non cacheable via l'attribut `AUDIO_DMA_BUFFER_ATTR` pointant sur la section `.ram_d2` alignée sur 32 bytes. Le linker/MPU doivent configurer cette section en non cacheable (documenté, sans modification dans cette passe).
- Le DMA RX écrit directement en RAM non cachée et le DMA TX lit directement en RAM non cachée : plus d'incohérence possible entre cache et périphérique pour les flux audio live.
- Les callbacks DMA RX/TX détectent explicitement les erreurs TEIF, DMEIF et FEIF et appellent immédiatement `chSysHalt("AUDIO DMA ERROR")` avant toute mise à jour d'index.
- Un halt franc est préféré à un bruit ou glitch destructeur en live : on coupe le son immédiatement plutôt que de propager un état incohérent.

V9 – Driver WS2812 (TIM8 + BDMA) durci
--------------------------------------
- Buffer PWM aligné 32 bytes et placé en `.ram_d2` non cacheable pour éviter toute incohérence D-Cache/BDMA sur H743.
- Mutex global, flag busy et compteur d'erreurs pour rendre render/update thread-safe et empêcher les re-entrances pendant un transfert.
- BDMA CH0 configuré avec interruptions TC/TE, callback d'erreur qui désactive/relance proprement le flux et re-synchronise TIM8 sans bloquer le système.
- Reset WS2812 garanti (>100 µs) via 80 slots à 800 kHz ; ajout de mesures de durée de frame et d'une API de diagnostic (busy/erreurs/temps µs) utilisable en live.
